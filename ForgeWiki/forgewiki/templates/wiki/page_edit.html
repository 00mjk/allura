{% extends 'wiki/master.html' %}

{% block title %}{{c.project.name}} / {{c.app.config.options.mount_label}} / {{page.title}}{% endblock %}

{% block header %}Edit {{page.title}}{% endblock %}

{% block extra_css %}
<style type="text/css">
  textarea[name=text]{
    height: 600px;
  }
</style>
{% endblock %}

{% block actions %}
  <a href="." title="View Page"><b data-icon="s" class="ico" title="View Page"></b></a>
  {% if page_exists and has_artifact_access('delete', page)() %}
    <a href="./delete" title="Delete"><b data-icon="D" class="ico" title="Delete"></b></a>
  {% endif %}
{% endblock %}

{% block wiki_content %}
<form method="POST" class="can-retry" action="update" id="page_edit_form">
	<label for="title" class="grid-4">Name:</label>
	<div class="grid-14">
	  <input type="text" name="title" id="title" value="{{page.title}}" placeholder="Page name" required="required" autofocus="autofocus"/>
	</div>
	<label for="text" class="grid-18">Content:</label>
	<div class="grid-18">
	  {{c.markdown_editor.display(name='text',value=page.text)}}
	</div>
	<label for="labels" class="grid-4">Labels:</label>
	<div class="grid-14" style="margin-left:0">
		{{c.label_edit.display(name='labels', value=page.labels)}}
	</div>
    {% if not page_exists or has_artifact_access('edit_page_permissions', page)() %}
      <label class="grid-4">Viewable by:</label>
      <div class="grid-14">
      {% set j = 0 %}
      {% for u in page.viewable_by %}
        <span class="removable">
          {{u}}
          <input type="hidden" name="viewable_by-{{j}}.id" value="{{u}}"/>
        </span>
        {% set j = j + 1 %}
      {% endfor %}
      </div>
      <label for="new_viewable_by" class="grid-4">Add Viewer:</label>
      <div class="grid-14">
        {{c.user_select.display(name='new_viewable_by', value='')}}
      </div>
    {% endif %}
    <label class="grid-4">&nbsp;</label>
    <div class="grid-14">
      <input type="submit" value="Save"/>
      <input type="reset" value="Cancel"/>
		</div>
</form>
<div class="grid-19">
  {{c.attachment_list.display(attachments=page.attachments, edit_mode=page_exists and has_artifact_access('edit', page)())}}
  {% if page_exists and has_artifact_access('edit', page)() %}
    {{c.attachment_add.display(action=page.url() + 'attach', name='file_info')}}
  {% endif %}
</div>
{% endblock %}

{% block wiki_extra_js %}
<script type="text/javascript">
  /*<![CDATA[*/
  $('span.removable').click(function(e){
    var vals = $('#page_edit_form').serialize();
    var del_name = $('input', this)[0].name.replace('.id','.delete');
    $.post($('#page_edit_form')[0].action, vals+'&'+del_name+'=Del', function(){
      e.target.parentNode.removeChild(e.target);
    });
  });
  /*]]>*/
</script>
{% endblock %}