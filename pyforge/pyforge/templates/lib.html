<html xmlns:py="http://genshi.edgewall.org/"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      py:strip="True">
  <?python from pyforge.lib.security import has_neighborhood_access ?>

  <ul py:def="project_tree(project)">
    <li py:for="p in project.direct_subprojects">
      <a href="${p.url()}">$p.shortname</a>
      <py:if test="p.direct_subprojects">
        ${project_tree(p)}
      </py:if>
    </li>
  </ul>

  <py:def function="nav(s)">
    <li>
      <a py:if="s.url" href="$s.url" class="$s.className">$s.label</a>
      <span py:if="not s.url" class="$s.className">$s.label</span>
      <ul py:if="s.children">
        <py:for each="ss in s.children">${nav(ss)}</py:for>
      </ul>
    </li>
  </py:def>

  <py:def function="main_menu()">
    <div id="mainmenu" class="span-24 last">
      <div class="sf_logo span-10"><a href="/"><img src="/images/sf.png"/></a></div>
      <div class="span-14 last">
        <a href="/auth/logout" py:if="c.user and c.user._id" class="sf_log_out">Log Out</a>
        <a href="/auth/" py:if="not c.user or not c.user._id" class="sf_log_in">Log In</a>
        <a href="${c.user.url()}" py:if="c.user and c.user._id" class="sf_user_link">$c.user.display_name</a>
        <a href="." py:if="not c.user or not c.user._id" class="sf_create_account todo">Create Account</a>
        <a href="/search/" class="sf_search_link">Search Site</a>
      </div>
    </div>
  </py:def>

  <py:def function="nav_menu()">
    <div id="nav_menu_missing" class="span-24 last" py:if="not c.project"/>
    <div id="nav_menu" class="span-24 last" py:if="c.project">

      <div class="span-2">
        <img py:if="c.project.icon" src="${c.project.url()}/icon" class="project_icon"/>
        <py:if test="not c.project.icon">&nbsp;</py:if>
      </div>
      <div class="span-15 project">
        <a py:if="c.project" href="${c.project.url()}" class="project_name">$c.project.name</a>

        <ul class="nav_links">
          <li py:for="s in c.project.sitemap()">
            <a py:if="s.url and s.label != 'Home'" href="$s.url" class="$s.className ${s.url[:-1] in request.url and 'active' or ''}">$s.label</a>
            <a py:if="s.url and s.label == 'Home'" href="$s.url" class="$s.className ${s.url[:-1] in request.url and 'active' or ''}"><img src="/images/home.png"/></a>
            <span py:if="not s.url" class="$s.className">$s.label</span>
          </li>
        </ul>
      </div>

      <div class="span-5 neighborhood">
        <a href="${c.project.neighborhood.url()}" class="neighborhood_name">$c.project.neighborhood.name</a><br/>
        <em class="neighborhood_member">Neighborhood Member</em>
      </div>
      <div class="span-2 last"><img py:if="c.project.neighborhood.icon" src="${c.project.neighborhood.url()}/icon" class="neighborhood_icon"/></div>
    </div>
  </py:def>

  <py:def function="sidebar_menu()">
    <div id="sidebar" class="span-4">
      <span id="app-search" py:if="c.app"><input type="text" class="defaultText" title="Search App"/></span>
      <py:if test="not c.app">&nbsp;</py:if>
      <ul id="sidebarmenu" py:if="getattr(c, 'app', None)">
        <li py:for="s in c.app.sidebar_menu()">
          <a py:if="s.url" href="$s.url" class="$s.className ${request.url.rfind(s.url,-len(s.url)) != -1 and 'active' or ''}">$s.label</a>
          <span py:if="not s.url" class="$s.className nav_head">$s.label</span>
        </li>
      </ul>
      <ul id="sidebarmenu"
          py:if="getattr(c, 'project', None) and not getattr(c, 'app', None)">
        <li py:for="s in c.project.sidebar_menu()">
          <a py:if="s.url" href="$s.url" class="$s.className ${s.url[:-1] in request.url and 'active' or ''}">$s.label</a>
          <span py:if="not s.url" class="$s.className nav_head">$s.label</span>
        </li>
      </ul>
    </div>
  </py:def>

  <py:def function="crumbs(trail)">
    <py:for each="i, (label, url) in enumerate(trail)">
      <li class="${i == 0 and 'first' or None}">
        <a py:if="url" href="$url">$label</a>
        <span py:if="not url">$label</span>
      </li>
    </py:for>
  </py:def>

  <py:def function="text_field(name, label, value=None)">
    <label for="$name">$label</label><br/>
    <input type="text" id="$name" name="$name" class="text" value="$value"/><br/>
  </py:def>

  <py:def function="file_field(name, label)">
    <label for="$name">$label</label><br/>
    <input type="file" id="$name" name="$name" class="text" /><br/>
  </py:def>

  <py:def function="text_area(name, label, value=None, **kw)">
    <label for="$name">$label</label><br/>
    <textarea id="$name" name="$name" py:attrs="kw">$value</textarea><br/>
  </py:def>

  <py:def function="select_field(name, label, options, value=None)">
    <label for="$name">$label</label><br/>
    <select id="$name" name="$name">
      <py:for each="olbl, oval in options">
        <option value="$oval" selected="${oval == value or None}">$olbl</option>
      </py:for>
    </select>
    <br/>
  </py:def>

  <py:def function="radio_button(name, label, option, value=None)">
    <py:if test="label">
      <label for="$name">$label</label><br/>
    </py:if>
    <input type="radio" id="$name" name="$name" class="text" value="$option" 
           checked="${option==value and 'on' or None}"/><br/>
  </py:def>

  <py:def function="checkbox(name, label, checked)">
    <input type="checkbox" id="$name" name="$name" 
           checked="${checked or None}"/>
    <py:if test="label">
      <label for="$name">$label</label>
    </py:if>
    <br/>
  </py:def>

  <py:def function="submit_button(value, name=None)">
    <input type="submit" name="$name" value="$value"/><br/>
  </py:def>

  <py:def function="list_attachments(attachments, edit_mode=False)">
    <div py:if="len(attachments)" py:strip="True">
      <strong>Attachments</strong>
      <div class="attachment_images">
        <div py:for="att in attachments" py:strip="True">
          <div py:if="att.contentType.startswith('image/')" class="attachment_thumb">
            <a href="${att.url()}">
              <img src="${att.url()}"/>
            </a><br/>
            $att.metadata.filename
            <form py:if="edit_mode" method="post" action="${att.url()}">
              <input type="hidden" name="delete" value="True"/>
              ${submit_button('Delete file')}
            </form>
          </div>
        </div>
      </div>
      <div py:for="att in attachments">
        <form py:if="not att.contentType.startswith('image/')" method="post" action="${att.url()}">
          <a href="${att.url()}">${att.metadata.filename}</a>
          ($att.length bytes)
            <input type="hidden" name="delete" value="True"/>
            <span py:if="edit_mode" py:strip="True">
              ${submit_button('Delete file')}
            </span>
        </form>
      </div>
    </div>
  </py:def>

  <py:def function="markdown_edit(name, content)">
  <div class="wmd_holder">
    <textarea id="wmd_edit_$name" class="wmd_edit" name="$name">$content</textarea>
    <div id="wmd_preview_$name" class="wmd_preview"></div>

    <script type="text/javascript">
        wmd_options = { autostart: false, output:"Markdown" };
    </script>
    <script type="text/javascript" src="/wmd/wmd.js"></script>
    <script type="text/javascript">
        (function() {
            var textarea = document.getElementById('wmd_edit_$name');
            var previewDiv = document.getElementById('wmd_preview_$name');

            var previewManager = new Attacklab.wmd.previewManager({
              input:textarea,
              preview:previewDiv,
              output:null
            });

            new Attacklab.wmd.editor(textarea,previewManager.refresh);
        })()
    </script>
  </div>
  </py:def>

  <py:def function="user_tags_edit(name, user_tags)">
    Tags:
    <input id="$name" name="$name" type="text" value="${','.join([t.tag for t in user_tags.tags])}" />
    <script type="text/javascript" src="/js/jquery.tag.editor.js"></script>
    <script type="text/javascript">
      $("#$name").tagEditor({
        confirmRemoval: false,
        completeOnSeparator: true,
        completeOnBlur: true
      });
    </script>
  </py:def>

  <py:def function="gravatar(email, **kw)">
    <img py:if="email" src="${g.gravatar(email, **kw)}" class="gravatar" alt="gravatar for $email"/>
    <img py:if="not email" src="/images/user.png" class="gravatar" alt="gravatar for $email"/>
  </py:def>
  
  <py:def function="select_user_in_project(name, value, size=None, all=False)">
    <?python from pyforge.model import User
      users = User.query.find({'_id':{'$in':[role.user_id for role in c.project.roles]}}).all()
      if not isinstance(value, list): value=[value]
    ?>
    <select id="$name" name="$name" size="$size" multiple="$size">
      <option py:if="all and 'all' in value" value="all" selected="selected">All</option>
      <option py:if="all and 'all' not in value" value="all">All</option>
      <py:for each="user in users">
        <py:if test="user._id in value or str(user._id) in value">
          <option value="${user._id or ''}" selected="selected">${user._id and user.display_name or 'nobody'}</option>
        </py:if>
        <py:if test="user._id not in value and str(user._id) not in value">
          <option value="${user._id or ''}">${user._id and user.display_name or 'nobody'}</option>
        </py:if>
      </py:for>
    </select>
  </py:def>
</html>
