{% extends 'jinja_master/master.html' %}

{% do g.register_forge_css('css/forge/accordion.css') %}
{% block extra_js %}
  <script type="text/javascript">
    $(function() {
      $("#acl-admin").accordion({
        autoHeight: false,
        change: function(event,ui) {
          var hid = ui.newHeader.children('a').attr('id');
          if (hid === undefined) {
            $.cookie('tracker-acl-admin', null);
          } else {
            $.cookie('tracker-acl-admin', hid, { path: '/', expires: 2 });
          }
        }
      });
    });
    $(document).ready(function(){
      if($.cookie('tracker-acl-admin')) {
        $('#acl-admin').accordion('option', 'animated', false)
                       .accordion('activate', $('#' + $.cookie('tracker-acl-admin')).parent('h3'))
                       .accordion('option', 'animated', 'slide');
      }
    });
  </script>
{% endblock %}

{% block title %}{{c.project.name}} / {{app.config.options.mount_label}} /  Admin Permissions{% endblock %}

{% block header %}{{app.config.options.mount_label}} Admin Permissions{% endblock %}

{% block content %}
  {% if app.permissions and allow_config %}
    <div id="acl-admin">
      {% for p in app.permissions %}
        <h3><a href="#" id="permission_{{p}}">{{p}}</a></h3>
        <div>
          <table>
            <thead>
              <tr>
                <th>Role</th>
                <th/>
              </tr>
            </thead>
            <tbody>
              {% for role in h.make_roles(app.config.acl[p]) %}
                <tr>
                  <td>{{role.display()}}</td>
                  <td>
                    <form method="POST" action="del_perm" style="display:inline">
                      <input type="hidden" name="permission" value="{{p}}"/>
                      <input type="hidden" name="role" value="{{role._id}}"/>
                      {% if role.display() != '*user-'+c.user.username %}
                        <input type="submit" value="Remove"/>
                      {% endif %}
                    </form>
                  </td>
                </tr>
              {% endfor %}
              <tr>
                <form method="POST" action="add_perm">
                  <td>
                    <select name="role">
                      {% for role in c.project.roles %}
                        <option value="{{role._id}}">{{role.display()}}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input type="hidden" name="permission" value="{{p}}"/>
                    <input type="submit" value="Add Permission"/>
                  </td>
                </form>
              </tr>
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endblock %}

{% block extra_css %}
  <style type="text/css">
    div.custom-field {
    cursor: move;
    border:1px solid #ccc;
    margin:2px;
    padding:2px;
    }
  </style>
{% endblock %}