{% extends 'allura:templates/repo/repo_master.html' %}
{% block title %}
{{c.project.name}} / {{c.app.config.options.mount_label}} / Commit {{commit.shorthand_id()}}
{% endblock %}

{% block header -%}
Commit <a href="{{commit.url()}}">{{commit.shorthand_id()}}</a> {{commit_labels(commit)}}
{%- endblock %}

{% block extra_js %}
{{ super() }}
<script type="text/javascript">$(function() {
    {% if status == 'ready' %}
        {% if 'no-redirect' not in request.params %}
            $(document).ready(function() {
                window.location.href = '{{c.app.repo.tarball_url(revision)}}';
            });
        {% endif %}
    {% else %}
        var opts = {
            lines: 9, // The number of lines to draw
            length: 4, // The length of each line
            width: 2, // The line thickness
            radius: 3, // The radius of the inner circle
            rotate: 0, // The rotation offset
            color: '#555', // #rgb or #rrggbb
            speed: 1, // Rounds per second
            trail: 60, // Afterglow percentage
            shadow: false, // Whether to render a shadow
            hwaccel: false, // Whether to use hardware acceleration
            className: 'spinner', // The CSS class to assign to the spinner
            zIndex: 2e9, // The z-index (defaults to 2000000000)
            top: 10, // Top position relative to parent in px
            left: 10 // Left position relative to parent in px
        };
        var spinner = new Spinner(opts).spin($('#snapshot_status')[0]);
        // Check tarball status every 5 seconds
        function check_status() {
            $.get('{{commit.url()}}tarball_status', function(data) {
                if (data.status === 'ready') {
                    window.clearInterval(status_checker);
                    spinner.stop();
                    $('#snapshot_status h2').toggle();
                    {% if 'no-redirect' not in request.params %}
                        window.location.href = '{{c.app.repo.tarball_url(revision)}}';
                    {% endif %}
                }
            });
        }
        var status_checker = window.setInterval(check_status, 5000);
    {% endif %}
});
</script>
{% endblock %}

{% block content %}
<div id='snapshot_status'>
    <h2 class="busy">Generating snapshot...</h2>
    <h2 class="ready">Your download will begin shortly, or use this <a href="{{c.app.repo.tarball_url(revision)}}">direct link</a>.</h2>
</div>
{% endblock %}

{% block extra_css %}
<style type="text/css">
    #snapshot_status h2 {
        padding-left: 33px;
    }
    #snapshot_status .{{ 'busy' if status == 'ready' else 'ready' }} {
        display: none;
    }
</style>
{% endblock %}
